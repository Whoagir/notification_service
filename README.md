
# Notification service

## Описание

**Notification service** — это RESTful API, разработанный с использованием FastAPI, предназначенный для создания, получения и управления уведомлениями. Сервис интегрируется с внешним AI API (в данном проекте используется мок) для анализа текста уведомлений и классификации их по категориям: `info`, `warning` или `critical`. Для обеспечения высокой производительности используются асинхронная обработка с Celery, кэширование с Redis и база данных PostgreSQL. Проект полностью контейнеризирован с помощью Docker и включает тесты для проверки функциональности.

### Основные возможности

- **Управление уведомлениями**: создание, получение списка, просмотр деталей и отметка уведомлений как прочитанных.
- **Интеграция с AI**: автоматический анализ текста уведомлений для определения категории.
- **Асинхронная обработка**: использование Celery для фонового анализа AI, чтобы API оставался отзывчивым.
- **Кэширование**: оптимизация частых запросов с помощью Redis.
- **Ограничение скорости**: защита от злоупотреблений с помощью лимита запросов.
- **Документация API**: интерактивная документация через Swagger UI и ReDoc.
- **Мониторинг**: сбор метрик с помощью Prometheus и визуализация в Grafana (бонусная функция).

---

## Технологии

- **Backend**: Python 3.10+, FastAPI
- **База данных**: PostgreSQL (или SQLite)
- **Кэширование и брокер сообщений**: Redis
- **Асинхронные задачи**: Celery
- **Контейнеризация**: Docker, Docker Compose
- **Тестирование**: Pytest, pytest-asyncio
- **Миграции**: Alembic
- **Логирование**: Настраиваемое логирование с выводом в консоль и файл
- **Мониторинг**: Prometheus, Grafana (бонус)

---

## Инструкции по установке

### 1. Клонирование репозитория

```bash
git clone https://github.com/yourusername/notification_service.git
cd notification_service
```

### 2. Установка зависимостей

Рекомендуется использовать виртуальное окружение:

```bash
python -m venv venv
source venv/bin/activate  # Для Windows: venv\Scripts\activate
pip install -r requirements.txt
```

### 3. Настройка переменных окружения

Создайте файл `.env` в корневой директории с следующим содержимым:

```
DATABASE_URL=postgresql+asyncpg://postgres:12345@localhost:5432/notification_service_db
REDIS_URL=redis://:12345@redis:6379/0
```

**Примечание**: При необходимости измените `DATABASE_URL` и `REDIS_URL` в зависимости от вашей среды.

### 4. Выполнение миграций базы данных

Убедитесь, что база данных запущена, затем выполните миграции:

```bash
alembic upgrade head
```

### 5. Запуск приложения

#### Использование Docker Compose (рекомендуется)

```bash
docker-compose up --build
```

Это запустит все сервисы: FastAPI приложение, Celery worker, Redis, PostgreSQL, Prometheus и Grafana.

#### Прямой запуск через Python

- Убедитесь, что Redis и PostgreSQL запущены.
- Запустите приложение FastAPI:

  ```bash
  uvicorn app.main:app --host 0.0.0.0 --port 8000
  ```

- Запустите Celery worker:

  ```bash
  celery -A app.celery_app worker --loglevel=info
  ```

---

## Документация API

После запуска приложения доступна интерактивная документация API:

- **Swagger UI**: [http://localhost:8000/docs](http://localhost:8000/docs)
- **ReDoc**: [http://localhost:8000/redoc](http://localhost:8000/redoc)
- **Prometheus**: http://localhost:9090
- **Grafana**: http://localhost:3000 (логин: admin, пароль: admin по умолчанию)

Документация содержит информацию о доступных эндпоинтах, схемах запросов/ответов и позволяет тестировать API напрямую.

---

## Запуск тестов

Проект включает юнит- и интеграционные тесты. Для их запуска:

```bash
# pytest
docker-compose up --build
docker-compose exec <web> pytest app/tests/test_main.py
```

**Примечание**: Тесты используют in-memory SQLite базу данных по умолчанию для изоляции и скорости.

---

## Архитектура

Проект построен по принципам чистой архитектуры с разделением ответственности:

- **Модели**: Определяют схему базы данных с использованием SQLAlchemy.
- **Репозитории**: Отвечают за операции с базой данных, абстрагируя доступ к данным.
- **Сервисы**: Содержат бизнес-логику, взаимодействуя с репозиториями.
- **Схемы**: Используют Pydantic для валидации и сериализации данных.
- **Мидлвары**: Реализуют дополнительные функции, такие как ограничение скорости.
- **Утилиты**: Вспомогательные функции, например, для настройки кэширования.

## Структура проекта

Проект организован следующим образом:
```
notification_service/
├── app/                    # Основная логика приложения
│   ├── api/                # Эндпоинты API
│   │   ├── __init__.py
│   │   └── v1/            # Версия API v1
│   │       ├── __init__.py
│   │       ├── router.py  # Маршрутизация API v1
│   │       └── endpoints/ # Эндпоинты API v1
│   │           ├── __init__.py
│   │           └── notifications.py
│   ├── config/            # Конфигурация
│   │   ├── database.py    # Настройки базы данных
│   │   └── logging_config.py # Настройки логирования
│   ├── middlewares/       # Промежуточное ПО
│   │   └── rate_limit.py  # Ограничение скорости запросов
│   ├── models/            # Модели SQLAlchemy
│   │   └── notification.py
│   ├── repositories/      # Репозитории для работы с БД
│   │   ├── __init__.py
│   │   └── notification_repository.py
│   ├── schemas/           # Схемы Pydantic
│   │   └── notification.py
│   ├── services/          # Бизнес-логика
│   │   ├── __init__.py
│   │   └── notification_service.py
│   ├── utils/             # Вспомогательные утилиты
│   │   └── cache.py       # Утилиты для кэширования
│   ├── tests/             # Тесты
│   │   ├── conftest.py    # Фикстуры для тестов
│   │   └── test_main.py   # Тесты основной функциональности
│   ├── __init__.py
│   ├── celery_app.py      # Настройка Celery
│   ├── exceptions.py      # Пользовательские исключения
│   ├── main.py            # Точка входа FastAPI
│   └── tasks.py           # Задачи Celery
├── migrations/            # Миграции Alembic
│   ├── versions/          # Версии миграций
│   │   └── a093be02d32c_initial_migration_with_indexes.py
│   ├── env.py             # Окружение для миграций
│   ├── README
│   └── script.py.mako     # Шаблон для миграций
├── .dockerignore          # Файлы, игнорируемые Docker
├── .env                   # Переменные окружения
├── .gitignore             # Файлы, игнорируемые Git
├── alembic.ini            # Конфигурация Alembic
├── Dockerfile             # Конфигурация Docker
├── docker-compose.yml     # Настройка сервисов
├── prometheus.yml         # Конфигурация Prometheus
├── pytest.ini             # Конфигурация pytest
├── README.md              # Документация проекта
└── requirements.txt       # Зависимости
```

### Ключевые архитектурные решения

- **Асинхронное программирование**: Использование `async/await` для неблокирующих операций ввода-вывода.
- **Фоновые задачи**: Celery обрабатывает анализ AI асинхронно, сохраняя отзывчивость API.
- **Кэширование**: Redis используется для кэширования частых запросов с кастомным построением ключей.
- **Оптимизация базы данных**: Индексы применены к часто запрашиваемым полям для ускорения выборок.

---

## Бонусные функции

- **Ограничение скорости**: Лимит запросов в минуту для предотвращения злоупотреблений.
- **Мониторинг**: Prometheus собирает метрики, а Grafana используется для визуализации (настроено в `docker-compose.yml`).

---

## Дополнительные заметки

- AI API замокан в `app/tasks.py` для демонстрационных целей. В продакшене его можно заменить на реальный сервис.
- Кэширование реализовано с использованием `fastapi-cache2` с кастомным построением ключей для учета параметров запроса.
- Логирование настроено для вывода в консоль и файл (`/app/app.log`) для удобства отладки и мониторинга.


